<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cambiar Contraseña - Thinking Skills</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;justify-content:center;align-items:center;min-height:100vh;color:#fff}
.card{background:rgba(255,255,255,0.95);padding:40px;border-radius:20px;box-shadow:0 15px 40px rgba(102,126,234,0.4);width:100%;max-width:450px;text-align:center}
.logo{font-size:2em;font-weight:700;margin-bottom:10px;color:#667eea}
.subtitle{font-size:1.1em;margin-bottom:30px;color:#764ba2}
.form-group{margin-bottom:20px;position:relative}
label{display:block;color:#667eea;font-weight:600;margin-bottom:8px;text-align:left}
input{width:100%;padding:14px;border:2px solid #b8c5f0;border-radius:12px;font-size:16px;background:#fff;transition:all 0.3s}
input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,0.2)}
.btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:14px;border:none;border-radius:12px;cursor:pointer;font-size:16px;font-weight:600;width:100%;margin-top:10px;transition:all 0.3s}
.btn:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(102,126,234,0.4)}
.btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
.alert{padding:12px;border-radius:12px;margin:15px 0;font-weight:500;display:none}
.alert-error{background:#fadbd8;color:#c0392b;border:2px solid #f5b7b1}
.alert-success{background:#d5f4e6;color:#27ae60;border:2px solid #a3e4d7}
.alert-warning{background:#fff3cd;color:#856404;border:2px solid #ffeaa7}
.spinner{display:inline-block;width:18px;height:18px;border:3px solid #fff;border-top:3px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.info{background:#e8f4fd;padding:15px;border-radius:10px;margin-bottom:20px;text-align:left;color:#1565c0;border-left:4px solid #2196f3}
</style>
</head>
<body>
<div class="card">
<div class="logo">Cambiar Contraseña</div>
<p class="subtitle">Primera vez - Crea tu contraseña personal</p>

<div class="info">
<strong>Importante:</strong><br>
Tu contraseña debe tener al menos 6 caracteres. Recuérdala bien, la necesitarás en tus próximas sesiones.
</div>

<div id="alertBox" class="alert"></div>

<form onsubmit="cambiarPassword(event)">
<div class="form-group">
<label>Nueva Contraseña</label>
<input type="password" id="nuevaPassword" required placeholder="Mínimo 6 caracteres" minlength="6">
</div>
<div class="form-group">
<label>Confirmar Contraseña</label>
<input type="password" id="confirmarPassword" required placeholder="Repite tu contraseña" minlength="6">
</div>
<button type="submit" class="btn" id="btnCambiar">
Cambiar Contraseña <span id="spinner" class="spinner" style="display:none"></span>
</button>
</form>
</div>

<script>
const URL = 'https://rxqiimwqlisnurgmtmtw.supabase.co/rest/v1';
const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4cWlpbXdxbGlzbnVyZ210bXR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MjcyNzcsImV4cCI6MjA3NzAwMzI3N30.meJx3YvbvwQJHvfLs52DZ9LppSJIVbBvyAVPqJfi9wg';

function showAlert(msg, type = 'error') {
    const a = document.getElementById('alertBox');
    a.className = 'alert alert-' + type;
    a.textContent = msg;
    a.style.display = 'block';
}

function hideAlert() {
    document.getElementById('alertBox').style.display = 'none';
}

// Verificar que hay usuario en localStorage
const userStr = localStorage.getItem('user');
if (!userStr) {
    alert('Sesión no válida. Redirigiendo al login...');
    location.href = 'index.html';
}
const user = JSON.parse(userStr);

async function cambiarPassword(e) {
    e.preventDefault();
    const nueva = document.getElementById('nuevaPassword').value;
    const confirmar = document.getElementById('confirmarPassword').value;
    const btn = document.getElementById('btnCambiar');
    const spinner = document.getElementById('spinner');
    
    if (nueva.length < 6) return showAlert('La contraseña debe tener al menos 6 caracteres');
    if (nueva !== confirmar) return showAlert('Las contraseñas no coinciden');
    if (nueva === 'TSP2025') return showAlert('No puedes usar la contraseña por defecto');
    
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    hideAlert();
    
    try {
        // 1. Actualizar contraseña
        const rUpdate = await fetch(`${URL}/estudiantes?codigo_estudiante=eq.${user.codigo_estudiante}`, {
            method: 'PATCH',
            headers: {
                'apikey': KEY,
                'Authorization': 'Bearer ' + KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify({ password: nueva })
        });
        
        if (!rUpdate.ok) throw new Error('Error al actualizar contraseña');
        
        showAlert('Contraseña actualizada exitosamente', 'success');
        
        // IMPORTANTE: Obtener el grado actualizado del estudiante desde la base de datos
        // Esto asegura que usamos el grado correcto para redirigir
        const rEstudiante = await fetch(`${URL}/estudiantes?codigo_estudiante=eq.${user.codigo_estudiante}&select=grado`, {
            headers: { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY }
        });
        
        if (!rEstudiante.ok) throw new Error('Error al obtener información del estudiante');
        const dataEstudiante = await rEstudiante.json();
        if (!dataEstudiante || dataEstudiante.length === 0) throw new Error('Estudiante no encontrado');
        
        // Usar el grado de la base de datos (más confiable)
        const gradoEstudiante = dataEstudiante[0].grado;
        
        // IMPORTANTE: Determinar el ciclo correcto según el grado
        // Mapeo de grados a ciclos basado en las plataformas actuales
        const cicloPorGrado = {
            1: 1, 2: 1, 3: 2, 4: 1, 5: 1, 6: 1,
            7: 1, 8: 2, 9: 2, 10: 2
        };
        const CICLO_ACTUAL = cicloPorGrado[gradoEstudiante] || 1;
        
        // IMPORTANTE: Siempre redirigir a la plataforma después de cambiar contraseña
        // La plataforma misma verificará si la actividad específica (por título) ya fue completada
        // Esto permite que nuevas plataformas con diferentes lecturas sean accesibles
        
        // Crear sesión activa y luego ir a la plataforma
        showAlert('Creando sesión...', 'success');
        
        // Crear o actualizar sesión activa antes de redirigir
        try {
            // Intentar actualizar sesión existente primero
            const rUpdateSesion = await fetch(
                `${URL}/sesiones_activas?codigo_estudiante=eq.${user.codigo_estudiante}&grado=eq.${gradoEstudiante}&ciclo=eq.${CICLO_ACTUAL}`, 
                {
                    method: 'PATCH',
                    headers: {
                        'apikey': KEY,
                        'Authorization': 'Bearer ' + KEY,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        sesion_activa: true
                    })
                }
            );
            
            const updateData = rUpdateSesion.ok ? await rUpdateSesion.json().catch(() => []) : [];
            
            // Si no se actualizó nada (no existe), crear nueva sesión
            if (!rUpdateSesion.ok || (Array.isArray(updateData) && updateData.length === 0)) {
                const rCrearSesion = await fetch(`${URL}/sesiones_activas`, {
                    method: 'POST',
                    headers: {
                        'apikey': KEY,
                        'Authorization': 'Bearer ' + KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        codigo_estudiante: user.codigo_estudiante,
                        grado: gradoEstudiante,
                        ciclo: CICLO_ACTUAL,
                        sesion_activa: true
                    })
                });
                
                // Si falla con 409 (conflicto), la sesión existe, actualizar de nuevo
                if (rCrearSesion.status === 409) {
                    await fetch(
                        `${URL}/sesiones_activas?codigo_estudiante=eq.${user.codigo_estudiante}&grado=eq.${gradoEstudiante}&ciclo=eq.${CICLO_ACTUAL}`, 
                        {
                            method: 'PATCH',
                            headers: {
                                'apikey': KEY,
                                'Authorization': 'Bearer ' + KEY,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                sesion_activa: true
                            })
                        }
                    );
                } else if (!rCrearSesion.ok) {
                    throw new Error('Error al crear sesión');
                }
            }
            
            // IMPORTANTE: Verificar que la sesión se creó correctamente antes de redirigir
            // Esperar y verificar con reintentos para asegurar que la sesión esté disponible
            let sesionVerificada = null;
            let intentosVerificacion = 0;
            const maxIntentosVerificacion = 5;
            
            while (intentosVerificacion < maxIntentosVerificacion) {
                await new Promise(resolve => setTimeout(resolve, 800)); // Esperar 800ms entre intentos
                
                const rVerificar = await fetch(
                    `${URL}/sesiones_activas?codigo_estudiante=eq.${user.codigo_estudiante}&grado=eq.${gradoEstudiante}&ciclo=eq.${CICLO_ACTUAL}&sesion_activa=eq.true`,
                    {
                        headers: { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY }
                    }
                );
                sesionVerificada = await rVerificar.json();
                
                if (sesionVerificada && sesionVerificada.length > 0) {
                    // Sesión encontrada, salir del bucle
                    break;
                }
                
                intentosVerificacion++;
            }
            
            if (!sesionVerificada || sesionVerificada.length === 0) {
                throw new Error('No se pudo verificar la sesión. Por favor intenta de nuevo.');
            }
            
            // Actualizar el objeto user con el grado correcto y guardar en localStorage
            user.grado = gradoEstudiante;
            localStorage.setItem('user', JSON.stringify(user));
            localStorage.setItem('sessionActive', 'true');
            
            showAlert('Sesión creada. Redirigiendo a la plataforma...', 'success');
            setTimeout(() => {
                // Redirigir a la plataforma correspondiente al grado del estudiante
                location.href = `plataformas/grado_${gradoEstudiante}.html?student=${user.codigo_estudiante}`;
            }, 1000);
            
        } catch (err) {
            console.error(err);
            showAlert('Error al crear sesión: ' + err.message);
            btn.disabled = false;
            spinner.style.display = 'none';
        }
        
    } catch (err) {
        console.error(err);
        showAlert('Error: ' + err.message);
        btn.disabled = false;
        spinner.style.display = 'none';
    }
}

// Función para mostrar resultados (igual que en index.html)
async function mostrarResultados(lectura, user) {
    // Obtener desafío mental
    let desafioData = null;
    try {
        const rDesafio = await fetch(`${URL}/steam_desafios?codigo_estudiante=eq.${user.codigo_estudiante}&grado=eq.${lectura.grado}&ciclo=eq.1`, {
            headers: { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY }
        });
        const desafios = await rDesafio.json();
        if (desafios && desafios.length > 0) desafioData = desafios[0];
    } catch (e) {}
    
    // Obtener aplicaciones
    let appsData = [];
    try {
        const rApps = await fetch(`${URL}/aplicaciones?codigo_estudiante=eq.${user.codigo_estudiante}&grado=eq.${lectura.grado}&ciclo=eq.1`, {
            headers: { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY }
        });
        appsData = await rApps.json() || [];
    } catch (e) {}
    
    const desafioHTML = desafioData ? `
        <div style="background: #fff3e0; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #ff9800;">
            <h3 style="color: #e65100; margin-bottom: 12px; font-size: 1.1em;">Desafío Mental</h3>
            <div style="margin: 8px 0; color: #333;"><strong>Calificación:</strong> ${desafioData.porcentaje || 'N/A'}%</div>
            <div style="margin: 8px 0; color: #333;"><strong>Estado:</strong> ${desafioData.porcentaje >= 80 ? 'Excelente' : desafioData.porcentaje >= 60 ? 'Bueno' : 'En progreso'}</div>
        </div>
    ` : '<div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 15px; color: #666;">Desafío Mental: No completado</div>';
    
    const appsHTML = appsData.length > 0 ? appsData.map(app => `
        <div style="background: #f3e5f5; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #9c27b0;">
            <div style="color: #6a1b9a; font-weight: 600; margin-bottom: 5px;">${app.habilidad || 'Aplicación'}</div>
            <div style="color: #333;"><strong>Puntaje:</strong> ${app.resultado || 'N/A'} / ${app.meta || 100}</div>
            <div style="color: #333;"><strong>Porcentaje:</strong> ${app.efectividad || 'N/A'}%</div>
        </div>
    `).join('') : '<div style="background: #f5f5f5; padding: 15px; border-radius: 10px; color: #666;">Aplicaciones: No completadas</div>';
    
    const resultadosHTML = `
        <div style="background: white; padding: 35px; border-radius: 20px; box-shadow: 0 15px 50px rgba(0,0,0,0.3); max-width: 900px; margin: 20px auto;">
            <h2 style="color: #667eea; text-align: center; margin-bottom: 25px; font-size: 1.8em;">
                Resultados de tu última sesión<br>
                <span style="font-size: 0.7em; color: #764ba2;">Thinking Skills Program</span>
            </h2>
            
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(102,126,234,0.3);">
                <div style="margin: 10px 0; font-size: 1.1em;"><strong>Estudiante:</strong> ${user.nombre} ${user.apellidos}</div>
                <div style="margin: 10px 0;"><strong>Lectura:</strong> ${lectura.titulo_lectura || 'N/A'}</div>
                <div style="margin: 10px 0;"><strong>Grado:</strong> ${lectura.grado} - Ciclo ${lectura.ciclo}</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3;">
                    <h3 style="color: #1565c0; margin-bottom: 15px; font-size: 1.2em;">Lectura</h3>
                    <div style="margin: 8px 0; color: #333;"><strong>Palabras:</strong> ${lectura.word_count || 'N/A'}</div>
                    <div style="margin: 8px 0; color: #333;"><strong>Tiempo:</strong> ${lectura.tiempo_minutos || 'N/A'} min</div>
                    <div style="margin: 8px 0; color: #333;"><strong>Vel. Simple:</strong> ${lectura.velocidad_simple || 'N/A'} p/m</div>
                    <div style="margin: 8px 0; color: #333;"><strong>Vocabulario:</strong> ${lectura.preguntas_vocabulario_correctas || 'N/A'}/${lectura.preguntas_vocabulario_totales || 'N/A'} (${Math.round((lectura.preguntas_vocabulario_correctas / lectura.preguntas_vocabulario_totales) * 100) || 'N/A'}%)</strong></div>
                    <div style="margin: 8px 0; color: #333;"><strong>Comprensión:</strong> ${lectura.preguntas_correctas || 'N/A'}/${lectura.preguntas_totales || 'N/A'} (${lectura.comprension || 'N/A'}%)</strong></div>
                    <div style="margin: 8px 0; color: #333;"><strong>Vel. Efectiva:</strong> ${lectura.velocidad_efectiva || 'N/A'}</strong></div>
                </div>

                <div>
                    ${desafioHTML}
                    <div style="background: #fce4ec; padding: 15px; border-radius: 10px; border-left: 4px solid #e91e63;">
                        <h3 style="color: #c2185b; margin-bottom: 12px; font-size: 1.1em;">Aplicaciones Brain Training</h3>
                        ${appsHTML}
                    </div>
                </div>
            </div>

            <div style="background: #fff9c4; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; border: 2px solid #fbc02d;">
                <p style="margin-bottom: 10px; font-weight: 600; color: #333; font-size: 1.1em;">Si deseas repetir la prueba, contacta al administrador:</p>
                <p style="font-size: 1.3em; color: #667eea; font-weight: bold; margin: 5px 0;">Hansel Peña Diaz</p>
                <p style="font-size: 1.4em; color: #667eea; font-weight: bold;">3143090748</p>
            </div>

            <button onclick="location.href='index.html'" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; width: 100%; box-shadow: 0 4px 15px rgba(102,126,234,0.4); transition: all 0.3s;">
                Volver al Login
            </button>
        </div>
    `;
    
    document.body.innerHTML = `
        <div style="background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%); min-height: 100vh; padding: 20px; display: flex; align-items: center; justify-content: center;">
            ${resultadosHTML}
            <div style="position: fixed; bottom: 20px; left: 0; right: 0; text-align: center; color: white; font-size: 13px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                Designed by <strong>Hansel Peña Diaz</strong> - 3143090748
            </div>
        </div>
    `;
}

// Limpiar alerta al escribir
document.getElementById('nuevaPassword').addEventListener('input', hideAlert);
document.getElementById('confirmarPassword').addEventListener('input', hideAlert);
</script>

</body>
</html>